<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, 
                   "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
    }

    .logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      background: linear-gradient(135deg, #54a0ff, #667eea);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    h1 {
      font-size: 24px;
      color: #2d3748;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .subtitle {
      color: #718096;
      font-size: 15px;
      margin-bottom: 32px;
      line-height: 1.6;
    }

    .status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px 24px;
      background: #f7fafc;
      border-radius: 12px;
      margin-bottom: 24px;
      font-size: 14px;
      color: #4a5568;
      font-weight: 500;
    }

    .status.success {
      background: #c6f6d5;
      color: #22543d;
    }

    .status.error {
      background: #fed7d7;
      color: #742a2a;
    }

    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid #e2e8f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .checkmark {
      width: 18px;
      height: 18px;
      color: #38a169;
    }

    .error-icon {
      width: 18px;
      height: 18px;
      color: #e53e3e;
    }

    .logs {
      background: #1a202c;
      border-radius: 12px;
      padding: 20px;
      max-height: 300px;
      overflow-y: auto;
      text-align: left;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      margin-top: 24px;
      scrollbar-width: thin;
      scrollbar-color: #4a5568 #2d3748;
    }

    .logs::-webkit-scrollbar {
      width: 8px;
    }

    .logs::-webkit-scrollbar-track {
      background: #2d3748;
      border-radius: 4px;
    }

    .logs::-webkit-scrollbar-thumb {
      background: #4a5568;
      border-radius: 4px;
    }

    .log-entry {
      margin-bottom: 8px;
      line-height: 1.5;
      color: #e2e8f0;
    }

    .log-time {
      color: #718096;
      margin-right: 8px;
    }

    .log-info { color: #63b3ed; }
    .log-success { color: #68d391; }
    .log-error { color: #fc8181; }
    .log-warn { color: #f6ad55; }

    .footer {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid #e2e8f0;
      color: #a0aec0;
      font-size: 13px;
    }

    .footer a {
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    /* ÈöêËóèÊ®°Âºè - ÂΩìÂú® iframe ‰∏≠Êó∂ */
    body.hidden-mode {
      background: transparent;
      padding: 0;
    }

    body.hidden-mode .container {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">‚úàÔ∏è</div>
    <h1 id="title">Connect Telegram</h1>
    <p class="subtitle" id="subtitle">please wait...</p>
    
    <div class="status" id="status">
      <div class="spinner"></div>
      <span id="status-text">init...</span>
    </div>

    <div class="logs" id="logs"></div>

    <div class="footer">
       <a href="https://telegram.org" target="_blank">Telegram</a>
    </div>
  </div>

  <script>
    // ============================================
    // ÈÖçÁΩÆ
    // ============================================
    const DEBUG = true; // ÂºÄÂèëÊó∂ÊòæÁ§∫UIÔºåÁîü‰∫ßÊó∂ËÆæ‰∏∫ false

    // ============================================
    // Áä∂ÊÄÅÁÆ°ÁêÜ
    // ============================================
    const state = {
      botId: null,
      authPopup: null,
      checkInterval: null,
      logs: []
    };

    // ============================================
    // UI ÊéßÂà∂
    // ============================================
    const UI = {
      updateStatus(text, type = 'loading') {
        const statusEl = document.getElementById('status');
        const statusText = document.getElementById('status-text');
        
        statusEl.className = 'status';
        statusText.textContent = text;

        if (type === 'success') {
          statusEl.classList.add('success');
          statusEl.innerHTML = `
            <svg class="checkmark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>${text}</span>
          `;
        } else if (type === 'error') {
          statusEl.classList.add('error');
          statusEl.innerHTML = `
            <svg class="error-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span>${text}</span>
          `;
        } else {
          statusEl.innerHTML = `
            <div class="spinner"></div>
            <span>${text}</span>
          `;
        }
      },

      updateTitle(title, subtitle = '') {
        document.getElementById('title').textContent = title;
        document.getElementById('subtitle').textContent = subtitle;
      },

      addLog(message, type = 'info') {
        const time = new Date().toLocaleTimeString('zh-CN', {
          hour12: false,
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });

        state.logs.push({ time, message, type });

        const logsEl = document.getElementById('logs');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `
          <span class="log-time">[${time}]</span>
          <span class="log-${type}">${message}</span>
        `;
        
        logsEl.appendChild(entry);
        logsEl.scrollTop = logsEl.scrollHeight;

        // ÂêåÊó∂ËæìÂá∫Âà∞ÊéßÂà∂Âè∞
        console.log(`[${type.toUpperCase()}] ${message}`);
      },

      hideUI() {
        document.body.classList.add('hidden-mode');
      }
    };

    // ============================================
    // Ê∂àÊÅØÈÄö‰ø°
    // ============================================
    function notifyParent(type, data = null, error = null) {
      const message = {
        type: type,
        data: data,
        error: error,
        timestamp: Date.now()
      };

      UI.addLog(`ÂèëÈÄÅÊ∂àÊÅØÁªôÁà∂Á™óÂè£: ${type}`, 'info');

      if (window.parent && window.parent !== window) {
        window.parent.postMessage(message, '*');
        UI.addLog('‚úì Ê∂àÊÅØÂ∑≤ÂèëÈÄÅ', 'success');
      } else {
        UI.addLog('‚ö† ‰∏çÂú® iframe ‰∏≠', 'warn');
      }
    }

    // ============================================
    // ÊéàÊùÉÂ§ÑÁêÜ
    // ============================================
    function parseAuthResult(hash) {
      try {
        UI.addLog('ÂºÄÂßãËß£ÊûêÊéàÊùÉÊï∞ÊçÆ...', 'info');
        
        const encoded = hash.replace('#tgAuthResult=', '');
        UI.addLog(`Base64 Êï∞ÊçÆÈïøÂ∫¶: ${encoded.length}`, 'info');
        
        // Base64URL ‚Üí Base64
        const base64 = encoded.replace(/-/g, '+').replace(/_/g, '/');
        
        // Ëß£Á†Å
        const decoded = atob(base64);
        const json = decodeURIComponent(
          decoded.split('').map(c => 
            '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
          ).join('')
        );
        
        const authData = JSON.parse(json);
        UI.addLog('‚úì Êï∞ÊçÆËß£ÊûêÊàêÂäü', 'success');
        UI.addLog(`Áî®Êà∑: ${authData.first_name || ''} ${authData.last_name || ''}`, 'info');
        
        return authData;
      } catch (e) {
        UI.addLog(`‚úó Ëß£ÊûêÂ§±Ë¥•: ${e.message}`, 'error');
        throw e;
      }
    }

    function handleAuthResult(hash) {
      UI.updateStatus('Ê≠£Âú®Â§ÑÁêÜÊéàÊùÉÊï∞ÊçÆ...', 'loading');
      UI.updateTitle('Â§ÑÁêÜ‰∏≠', 'Ê≠£Âú®È™åËØÅÊÇ®ÁöÑË∫´‰ªΩ...');

      try {
        const authData = parseAuthResult(hash);
        
        UI.updateStatus('ÊéàÊùÉÊàêÂäüÔºÅ', 'success');
        UI.updateTitle('ÁôªÂΩïÊàêÂäü', 'Âç≥Â∞ÜËøîÂõûÂ∫îÁî®...');
        UI.addLog('Ê≠£Âú®ËøîÂõûÂ∫îÁî®...', 'success');
        
        notifyParent('telegram_auth_success', authData);
        
        setTimeout(() => {
          UI.addLog('ÊéàÊùÉÊµÅÁ®ãÂÆåÊàê', 'success');
        }, 500);

      } catch (e) {
        UI.updateStatus('ÊéàÊùÉÂ§±Ë¥•', 'error');
        UI.updateTitle('Âá∫Èîô‰∫Ü', 'ÊéàÊùÉÊï∞ÊçÆÂ§ÑÁêÜÂ§±Ë¥•');
        UI.addLog(`Â§ÑÁêÜÂ§±Ë¥•: ${e.message}`, 'error');
        notifyParent('telegram_auth_error', null, 'Êï∞ÊçÆÂ§ÑÁêÜÂ§±Ë¥•');
      }
    }

    function openTelegramAuth(botId) {
      UI.updateStatus('Ê≠£Âú®ÊâìÂºÄ Telegram ÊéàÊùÉ...', 'loading');
      UI.updateTitle('ËØ∑ÊéàÊùÉ', 'Âú®ÂºπÂá∫ÁöÑÁ™óÂè£‰∏≠ÂÆåÊàêÁôªÂΩï');
      UI.addLog(`‰ΩøÁî® Bot ID: ${botId}`, 'info');

      const currentUrl = window.location.origin + window.location.pathname;
      const authUrl = 'https://oauth.telegram.org/auth' +
        `?bot_id=${botId}` +
        `&origin=${encodeURIComponent(currentUrl)}` +
        `&return_to=${encodeURIComponent(currentUrl)}` +
        `&request_access=write`;

      UI.addLog('ÊéàÊùÉ URL Â∑≤ÁîüÊàê', 'info');

      // ËÆ°ÁÆóÂ±Ö‰∏≠‰ΩçÁΩÆ
      const width = 550;
      const height = 470;
      const left = Math.round((screen.width - width) / 2);
      const top = Math.round((screen.height - height) / 2);
      const features = `width=${width},height=${height},left=${left},top=${top}`;

      // ÊâìÂºÄÂºπÁ™ó
      state.authPopup = window.open(authUrl, 'telegram_auth', features);

      if (!state.authPopup) {
        UI.updateStatus('ÂºπÁ™óË¢´ÈòªÊ≠¢', 'error');
        UI.updateTitle('Âá∫Èîô‰∫Ü', 'ËØ∑ÂÖÅËÆ∏ÊµèËßàÂô®ÂºπÁ™ó');
        UI.addLog('‚úó ÂºπÁ™óË¢´ÊµèËßàÂô®ÈòªÊ≠¢', 'error');
        notifyParent('telegram_auth_error', null, 'ÂºπÁ™óË¢´ÈòªÊ≠¢');
        return;
      }

      UI.addLog('‚úì ÊéàÊùÉÁ™óÂè£Â∑≤ÊâìÂºÄ', 'success');
      UI.addLog('Á≠âÂæÖÁî®Êà∑ÊéàÊùÉ...', 'info');

      // ÁõëÂê¨ÂºπÁ™óÂÖ≥Èó≠
      state.checkInterval = setInterval(() => {
        if (state.authPopup && state.authPopup.closed) {
          clearInterval(state.checkInterval);
          UI.addLog('ÊéàÊùÉÁ™óÂè£Â∑≤ÂÖ≥Èó≠', 'warn');

          // Ê£ÄÊü•ÊòØÂê¶ÊúâÊéàÊùÉÊï∞ÊçÆ
          if (!window.location.hash.startsWith('#tgAuthResult=')) {
            UI.updateStatus('ÊéàÊùÉÂ∑≤ÂèñÊ∂à', 'error');
            UI.updateTitle('Â∑≤ÂèñÊ∂à', 'ÊÇ®ÂèñÊ∂à‰∫ÜÁôªÂΩï');
            UI.addLog('Áî®Êà∑ÂèØËÉΩÂèñÊ∂à‰∫ÜÊéàÊùÉ', 'warn');
            notifyParent('telegram_auth_cancel');
          }
        }
      }, 500);
    }

    // ============================================
    // ÂàùÂßãÂåñ
    // ============================================
    function init() {
      UI.addLog('üöÄ Bridge È°µÈù¢ÂêØÂä®', 'info');
      UI.addLog(`ÂΩìÂâç URL: ${window.location.href}`, 'info');

      // Ê£ÄÊü•ÊòØÂê¶Âú® iframe ‰∏≠
      const isInIframe = window.parent !== window;
      UI.addLog(`ËøêË°åÁéØÂ¢É: ${isInIframe ? 'iframe' : 'Áã¨Á´ãÈ°µÈù¢'}`, 'info');

      // Â¶ÇÊûú‰∏çÂú®ÂºÄÂèëÊ®°Âºè‰∏îÂú® iframe ‰∏≠ÔºåÈöêËóè UI
      if (!DEBUG && isInIframe) {
        UI.hideUI();
      }

      // ÈÄöÁü•Áà∂Á™óÂè£Â∑≤Â∞±Áª™
      if (isInIframe) {
        notifyParent('telegram_auth_ready');
      }

      // ‰ªé URL Ëé∑Âèñ bot_id
      const params = new URLSearchParams(window.location.search);
      state.botId = params.get('bot_id');

      if (!state.botId) {
        UI.updateStatus('ÈÖçÁΩÆÈîôËØØ', 'error');
        UI.updateTitle('Âá∫Èîô‰∫Ü', 'Áº∫Â∞ëÂøÖË¶ÅÂèÇÊï∞');
        UI.addLog('‚úó Áº∫Â∞ë bot_id ÂèÇÊï∞', 'error');
        notifyParent('telegram_auth_error', null, 'Áº∫Â∞ë bot_id');
        return;
      }

      UI.addLog(`‚úì Bot ID: ${state.botId}`, 'success');

      // Ê£ÄÊü•ÊòØÂê¶ÊòØÊéàÊùÉËøîÂõû
      const hash = window.location.hash;

      if (hash.startsWith('#tgAuthResult=')) {
        UI.addLog('Ê£ÄÊµãÂà∞ÊéàÊùÉËøîÂõûÊï∞ÊçÆ', 'success');
        handleAuthResult(hash);
      } else {
        UI.addLog('È¶ñÊ¨°Âä†ËΩΩÔºåÂáÜÂ§áÊâìÂºÄÊéàÊùÉÁ™óÂè£', 'info');
        // Âª∂Ëøü‰∏Ä‰∏ãÔºåËÆ© UI ÊòæÁ§∫Âá∫Êù•
        setTimeout(() => openTelegramAuth(state.botId), 500);
      }
    }

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // Ê∏ÖÁêÜ
    window.addEventListener('beforeunload', () => {
      if (state.checkInterval) {
        clearInterval(state.checkInterval);
      }
      if (state.authPopup && !state.authPopup.closed) {
        state.authPopup.close();
      }
    });
  </script>
</body>
</html>
