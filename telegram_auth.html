<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram æˆæƒä¸­...</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .container {
      text-align: center;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .log {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      text-align: left;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
    }
    .log-item {
      margin: 4px 0;
      padding: 4px;
      border-left: 3px solid #4ade80;
    }
    .log-error {
      border-left-color: #f87171;
    }
    .log-success {
      border-left-color: #4ade80;
    }
    .log-info {
      border-left-color: #60a5fa;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="spinner"></div>
    <h2>æ­£åœ¨å¤„ç† Telegram æˆæƒ...</h2>
    <p id="status">è¯·ç¨å€™</p>
    <div class="log" id="log"></div>
  </div>

  <script>
    (function () {
      const logContainer = document.getElementById('log');
      const statusEl = document.getElementById('status');
      
      // æ—¥å¿—å‡½æ•°
      function log(message, type = 'info') {
        const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
        const logItem = document.createElement('div');
        logItem.className = `log-item log-${type}`;
        logItem.textContent = `[${time}] ${message}`;
        logContainer.appendChild(logItem);
        logContainer.scrollTop = logContainer.scrollHeight;
        
        // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
        console.log(`[${type.toUpperCase()}] ${message}`);
      }

      function updateStatus(text) {
        statusEl.textContent = text;
      }

      try {
        log('ğŸš€ æˆæƒå¤„ç†è„šæœ¬å¯åŠ¨', 'info');
        log(`ğŸ“ å½“å‰ URL: ${window.location.href}`, 'info');
        log(`ğŸ”— Hash: ${window.location.hash}`, 'info');
        log(`â“ Search: ${window.location.search}`, 'info');
        log(`ğŸªŸ æ˜¯å¦æœ‰ opener: ${!!window.opener}`, 'info');

        let authData = {};

        // 1ï¸âƒ£ å°è¯•ä» hash ä¸­è§£æ (Telegram æ–°ç‰ˆ)
        if (window.location.hash.startsWith('#tgAuthResult=')) {
          log('ğŸ“¦ æ£€æµ‹åˆ° hash ä¸­çš„æˆæƒæ•°æ®', 'info');
          
          const encoded = window.location.hash.replace('#tgAuthResult=', '');
          log(`ğŸ” ç¼–ç æ•°æ®é•¿åº¦: ${encoded.length}`, 'info');
          
          try {
            // Base64URL â†’ Base64
            const base64 = encoded.replace(/-/g, '+').replace(/_/g, '/');
            log('ğŸ”„ å·²è½¬æ¢ä¸ºæ ‡å‡† Base64', 'info');
            
            // è§£ç 
            const decoded = atob(base64);
            log(`ğŸ“ è§£ç åé•¿åº¦: ${decoded.length}`, 'info');
            
            // è½¬æ¢ä¸º UTF-8
            const json = decodeURIComponent(
              decoded
                .split('')
                .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
                .join('')
            );
            
            authData = JSON.parse(json);
            log(`âœ… æˆåŠŸè§£æ JSON æ•°æ®`, 'success');
            log(`ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(authData, null, 2)}`, 'success');
          } catch (e) {
            log(`âŒ è§£æ hash æ•°æ®å¤±è´¥: ${e.message}`, 'error');
            console.error('Hash è§£æé”™è¯¯:', e);
          }
        }

        // 2ï¸âƒ£ å…œåº•:å°è¯•ä» query å‚æ•°è§£æ (è€ç‰ˆæœ¬)
        if (!Object.keys(authData).length && window.location.search) {
          log('ğŸ“¦ å°è¯•ä» query å‚æ•°è·å–æ•°æ®', 'info');
          
          const params = new URLSearchParams(window.location.search);
          for (const [key, value] of params.entries()) {
            authData[key] = value;
          }
          
          if (Object.keys(authData).length > 0) {
            log(`âœ… ä» query è·å–åˆ° ${Object.keys(authData).length} ä¸ªå­—æ®µ`, 'success');
            log(`ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(authData, null, 2)}`, 'success');
          }
        }

        // 3ï¸âƒ£ å‘é€æ•°æ®ç»™ Flutter Web
        if (Object.keys(authData).length === 0) {
          log('âš ï¸ æœªæ‰¾åˆ°æˆæƒæ•°æ®', 'error');
          updateStatus('æˆæƒæ•°æ®ä¸ºç©º');
        } else if (!window.opener) {
          log('âš ï¸ æ²¡æœ‰ opener çª—å£,æ— æ³•å‘é€æ•°æ®', 'error');
          updateStatus('æ— æ³•é€šä¿¡:çª—å£å·²å…³é—­');
        } else {
          log('ğŸ“¤ å‡†å¤‡å‘é€æ•°æ®ç»™çˆ¶çª—å£...', 'info');
          log(`ğŸ“Š æ•°æ®å­—æ®µ: ${Object.keys(authData).join(', ')}`, 'info');
          
          // ğŸ”¥ ç›´æ¥å‘é€è§£æåçš„å¯¹è±¡,ä¸åŒ…è£…åœ¨ tgAuthResult ä¸­
          window.opener.postMessage(authData, '*');
          
          log('âœ… postMessage å·²è°ƒç”¨', 'success');
          log(`ğŸ¯ ç›®æ ‡: * (ä»»æ„æº)`, 'info');
          updateStatus('æˆæƒæˆåŠŸ!çª—å£å³å°†å…³é—­...');
          
          // å»¶è¿Ÿå…³é—­,è®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
          setTimeout(() => {
            log('ğŸšª å‡†å¤‡å…³é—­çª—å£', 'info');
            window.close();
          }, 1500);
        }

      } catch (e) {
        log(`ğŸ’¥ è‡´å‘½é”™è¯¯: ${e.message}`, 'error');
        console.error('Telegram redirect error:', e);
        console.error('Stack trace:', e.stack);
        updateStatus('æˆæƒå¤±è´¥,è¯·é‡è¯•');
      }
    })();
  </script>
</body>
</html>
