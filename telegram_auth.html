<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram ç™»å½•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, 
                   "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
    }

    .logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      background: linear-gradient(135deg, #54a0ff, #667eea);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    h1 {
      font-size: 24px;
      color: #2d3748;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .subtitle {
      color: #718096;
      font-size: 15px;
      margin-bottom: 32px;
      line-height: 1.6;
    }

    .status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px 24px;
      background: #f7fafc;
      border-radius: 12px;
      margin-bottom: 24px;
      font-size: 14px;
      color: #4a5568;
      font-weight: 500;
    }

    .status.success {
      background: #c6f6d5;
      color: #22543d;
    }

    .status.error {
      background: #fed7d7;
      color: #742a2a;
    }

    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid #e2e8f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .checkmark {
      width: 18px;
      height: 18px;
      color: #38a169;
    }

    .error-icon {
      width: 18px;
      height: 18px;
      color: #e53e3e;
    }

    .logs {
      background: #1a202c;
      border-radius: 12px;
      padding: 20px;
      max-height: 300px;
      overflow-y: auto;
      text-align: left;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      margin-top: 24px;
      scrollbar-width: thin;
      scrollbar-color: #4a5568 #2d3748;
    }

    .logs::-webkit-scrollbar {
      width: 8px;
    }

    .logs::-webkit-scrollbar-track {
      background: #2d3748;
      border-radius: 4px;
    }

    .logs::-webkit-scrollbar-thumb {
      background: #4a5568;
      border-radius: 4px;
    }

    .log-entry {
      margin-bottom: 8px;
      line-height: 1.5;
      color: #e2e8f0;
    }

    .log-time {
      color: #718096;
      margin-right: 8px;
    }

    .log-info { color: #63b3ed; }
    .log-success { color: #68d391; }
    .log-error { color: #fc8181; }
    .log-warn { color: #f6ad55; }

    .footer {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid #e2e8f0;
      color: #a0aec0;
      font-size: 13px;
    }

    .footer a {
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    /* éšè—æ¨¡å¼ - å½“åœ¨ iframe ä¸­æ—¶ */
    body.hidden-mode {
      background: transparent;
      padding: 0;
    }

    body.hidden-mode .container {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">âœˆï¸</div>
    <h1 id="title">æ­£åœ¨è¿æ¥ Telegram</h1>
    <p class="subtitle" id="subtitle">è¯·ç¨å€™ï¼Œæ­£åœ¨å‡†å¤‡æˆæƒ...</p>
    
    <div class="status" id="status">
      <div class="spinner"></div>
      <span id="status-text">åˆå§‹åŒ–ä¸­...</span>
    </div>

    <div class="logs" id="logs"></div>

    <div class="footer">
      ç”± <a href="https://telegram.org" target="_blank">Telegram</a> æä¾›å®‰å…¨ç™»å½•
    </div>
  </div>

  <script>
    // ============================================
    // é…ç½®
    // ============================================
    const DEBUG = true; // å¼€å‘æ—¶æ˜¾ç¤ºUIï¼Œç”Ÿäº§æ—¶è®¾ä¸º false

    // ============================================
    // çŠ¶æ€ç®¡ç†
    // ============================================
    const state = {
      botId: null,
      authPopup: null,
      checkInterval: null,
      logs: []
    };

    // ============================================
    // UI æ§åˆ¶
    // ============================================
    const UI = {
      updateStatus(text, type = 'loading') {
        const statusEl = document.getElementById('status');
        const statusText = document.getElementById('status-text');
        
        statusEl.className = 'status';
        statusText.textContent = text;

        if (type === 'success') {
          statusEl.classList.add('success');
          statusEl.innerHTML = `
            <svg class="checkmark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>${text}</span>
          `;
        } else if (type === 'error') {
          statusEl.classList.add('error');
          statusEl.innerHTML = `
            <svg class="error-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span>${text}</span>
          `;
        } else {
          statusEl.innerHTML = `
            <div class="spinner"></div>
            <span>${text}</span>
          `;
        }
      },

      updateTitle(title, subtitle = '') {
        document.getElementById('title').textContent = title;
        document.getElementById('subtitle').textContent = subtitle;
      },

      addLog(message, type = 'info') {
        const time = new Date().toLocaleTimeString('zh-CN', {
          hour12: false,
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });

        state.logs.push({ time, message, type });

        const logsEl = document.getElementById('logs');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `
          <span class="log-time">[${time}]</span>
          <span class="log-${type}">${message}</span>
        `;
        
        logsEl.appendChild(entry);
        logsEl.scrollTop = logsEl.scrollHeight;

        // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
        console.log(`[${type.toUpperCase()}] ${message}`);
      },

      hideUI() {
        document.body.classList.add('hidden-mode');
      }
    };

    // ============================================
    // æ¶ˆæ¯é€šä¿¡
    // ============================================
    function notifyParent(type, data = null, error = null) {
      const message = {
        type: type,
        data: data,
        error: error,
        timestamp: Date.now()
      };

      UI.addLog(`å‘é€æ¶ˆæ¯ç»™çˆ¶çª—å£: ${type}`, 'info');

      if (window.parent && window.parent !== window) {
        window.parent.postMessage(message, '*');
        UI.addLog('âœ“ æ¶ˆæ¯å·²å‘é€', 'success');
      } else {
        UI.addLog('âš  ä¸åœ¨ iframe ä¸­', 'warn');
      }
    }

    // ============================================
    // æˆæƒå¤„ç†
    // ============================================
    function parseAuthResult(hash) {
      try {
        UI.addLog('å¼€å§‹è§£ææˆæƒæ•°æ®...', 'info');
        
        const encoded = hash.replace('#tgAuthResult=', '');
        UI.addLog(`Base64 æ•°æ®é•¿åº¦: ${encoded.length}`, 'info');
        
        // Base64URL â†’ Base64
        const base64 = encoded.replace(/-/g, '+').replace(/_/g, '/');
        
        // è§£ç 
        const decoded = atob(base64);
        const json = decodeURIComponent(
          decoded.split('').map(c => 
            '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
          ).join('')
        );
        
        const authData = JSON.parse(json);
        UI.addLog('âœ“ æ•°æ®è§£ææˆåŠŸ', 'success');
        UI.addLog(`ç”¨æˆ·: ${authData.first_name || ''} ${authData.last_name || ''}`, 'info');
        
        return authData;
      } catch (e) {
        UI.addLog(`âœ— è§£æå¤±è´¥: ${e.message}`, 'error');
        throw e;
      }
    }

    function handleAuthResult(hash) {
      UI.updateStatus('æ­£åœ¨å¤„ç†æˆæƒæ•°æ®...', 'loading');
      UI.updateTitle('å¤„ç†ä¸­', 'æ­£åœ¨éªŒè¯æ‚¨çš„èº«ä»½...');

      try {
        const authData = parseAuthResult(hash);
        
        UI.updateStatus('æˆæƒæˆåŠŸï¼', 'success');
        UI.updateTitle('ç™»å½•æˆåŠŸ', 'å³å°†è¿”å›åº”ç”¨...');
        UI.addLog('æ­£åœ¨è¿”å›åº”ç”¨...', 'success');
        
        notifyParent('telegram_auth_success', authData);
        
        setTimeout(() => {
          UI.addLog('æˆæƒæµç¨‹å®Œæˆ', 'success');
        }, 500);

      } catch (e) {
        UI.updateStatus('æˆæƒå¤±è´¥', 'error');
        UI.updateTitle('å‡ºé”™äº†', 'æˆæƒæ•°æ®å¤„ç†å¤±è´¥');
        UI.addLog(`å¤„ç†å¤±è´¥: ${e.message}`, 'error');
        notifyParent('telegram_auth_error', null, 'æ•°æ®å¤„ç†å¤±è´¥');
      }
    }

    function openTelegramAuth(botId) {
      UI.updateStatus('æ­£åœ¨æ‰“å¼€ Telegram æˆæƒ...', 'loading');
      UI.updateTitle('è¯·æˆæƒ', 'åœ¨å¼¹å‡ºçš„çª—å£ä¸­å®Œæˆç™»å½•');
      UI.addLog(`ä½¿ç”¨ Bot ID: ${botId}`, 'info');

      const currentUrl = window.location.origin + window.location.pathname;
      const authUrl = 'https://oauth.telegram.org/auth' +
        `?bot_id=${botId}` +
        `&origin=${encodeURIComponent(currentUrl)}` +
        `&return_to=${encodeURIComponent(currentUrl)}` +
        `&request_access=write`;

      UI.addLog('æˆæƒ URL å·²ç”Ÿæˆ', 'info');

      // è®¡ç®—å±…ä¸­ä½ç½®
      const width = 550;
      const height = 470;
      const left = Math.round((screen.width - width) / 2);
      const top = Math.round((screen.height - height) / 2);
      const features = `width=${width},height=${height},left=${left},top=${top}`;

      // æ‰“å¼€å¼¹çª—
      state.authPopup = window.open(authUrl, 'telegram_auth', features);

      if (!state.authPopup) {
        UI.updateStatus('å¼¹çª—è¢«é˜»æ­¢', 'error');
        UI.updateTitle('å‡ºé”™äº†', 'è¯·å…è®¸æµè§ˆå™¨å¼¹çª—');
        UI.addLog('âœ— å¼¹çª—è¢«æµè§ˆå™¨é˜»æ­¢', 'error');
        notifyParent('telegram_auth_error', null, 'å¼¹çª—è¢«é˜»æ­¢');
        return;
      }

      UI.addLog('âœ“ æˆæƒçª—å£å·²æ‰“å¼€', 'success');
      UI.addLog('ç­‰å¾…ç”¨æˆ·æˆæƒ...', 'info');

      // ç›‘å¬å¼¹çª—å…³é—­
      state.checkInterval = setInterval(() => {
        if (state.authPopup && state.authPopup.closed) {
          clearInterval(state.checkInterval);
          UI.addLog('æˆæƒçª—å£å·²å…³é—­', 'warn');

          // æ£€æŸ¥æ˜¯å¦æœ‰æˆæƒæ•°æ®
          if (!window.location.hash.startsWith('#tgAuthResult=')) {
            UI.updateStatus('æˆæƒå·²å–æ¶ˆ', 'error');
            UI.updateTitle('å·²å–æ¶ˆ', 'æ‚¨å–æ¶ˆäº†ç™»å½•');
            UI.addLog('ç”¨æˆ·å¯èƒ½å–æ¶ˆäº†æˆæƒ', 'warn');
            notifyParent('telegram_auth_cancel');
          }
        }
      }, 500);
    }

    // ============================================
    // åˆå§‹åŒ–
    // ============================================
    function init() {
      UI.addLog('ğŸš€ Bridge é¡µé¢å¯åŠ¨', 'info');
      UI.addLog(`å½“å‰ URL: ${window.location.href}`, 'info');

      // æ£€æŸ¥æ˜¯å¦åœ¨ iframe ä¸­
      const isInIframe = window.parent !== window;
      UI.addLog(`è¿è¡Œç¯å¢ƒ: ${isInIframe ? 'iframe' : 'ç‹¬ç«‹é¡µé¢'}`, 'info');

      // å¦‚æœä¸åœ¨å¼€å‘æ¨¡å¼ä¸”åœ¨ iframe ä¸­ï¼Œéšè— UI
      if (!DEBUG && isInIframe) {
        UI.hideUI();
      }

      // é€šçŸ¥çˆ¶çª—å£å·²å°±ç»ª
      if (isInIframe) {
        notifyParent('telegram_auth_ready');
      }

      // ä» URL è·å– bot_id
      const params = new URLSearchParams(window.location.search);
      state.botId = params.get('bot_id');

      if (!state.botId) {
        UI.updateStatus('é…ç½®é”™è¯¯', 'error');
        UI.updateTitle('å‡ºé”™äº†', 'ç¼ºå°‘å¿…è¦å‚æ•°');
        UI.addLog('âœ— ç¼ºå°‘ bot_id å‚æ•°', 'error');
        notifyParent('telegram_auth_error', null, 'ç¼ºå°‘ bot_id');
        return;
      }

      UI.addLog(`âœ“ Bot ID: ${state.botId}`, 'success');

      // æ£€æŸ¥æ˜¯å¦æ˜¯æˆæƒè¿”å›
      const hash = window.location.hash;

      if (hash.startsWith('#tgAuthResult=')) {
        UI.addLog('æ£€æµ‹åˆ°æˆæƒè¿”å›æ•°æ®', 'success');
        handleAuthResult(hash);
      } else {
        UI.addLog('é¦–æ¬¡åŠ è½½ï¼Œå‡†å¤‡æ‰“å¼€æˆæƒçª—å£', 'info');
        // å»¶è¿Ÿä¸€ä¸‹ï¼Œè®© UI æ˜¾ç¤ºå‡ºæ¥
        setTimeout(() => openTelegramAuth(state.botId), 500);
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // æ¸…ç†
    window.addEventListener('beforeunload', () => {
      if (state.checkInterval) {
        clearInterval(state.checkInterval);
      }
      if (state.authPopup && !state.authPopup.closed) {
        state.authPopup.close();
      }
    });
  </script>
</body>
</html>
