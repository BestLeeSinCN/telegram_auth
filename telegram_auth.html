<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram æˆæƒä¸­...</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
    }
    .container {
      text-align: center;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      max-width: 600px;
      width: 100%;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .log {
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      text-align: left;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
    }
    .log-item {
      margin: 4px 0;
      padding: 4px;
      border-left: 3px solid #4ade80;
      word-break: break-all;
    }
    .log-error {
      border-left-color: #f87171;
    }
    .log-success {
      border-left-color: #4ade80;
    }
    .log-info {
      border-left-color: #60a5fa;
    }
    .buttons {
      margin-top: 1rem;
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-close {
      background: #ef4444;
      color: white;
    }
    .btn-close:hover {
      background: #dc2626;
    }
    .btn-copy {
      background: #3b82f6;
      color: white;
    }
    .btn-copy:hover {
      background: #2563eb;
    }
    .countdown {
      font-size: 14px;
      margin-top: 10px;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="spinner" id="spinner"></div>
    <h2>Telegram æˆæƒå¤„ç†</h2>
    <p id="status">æ­£åœ¨å¤„ç†æˆæƒæ•°æ®...</p>
    <div class="countdown" id="countdown"></div>
    <div class="log" id="log"></div>
    <div class="buttons">
      <button class="btn-copy" onclick="copyLogs()">ğŸ“‹ å¤åˆ¶æ—¥å¿—</button>
      <button class="btn-close" onclick="window.close()">âŒ æ‰‹åŠ¨å…³é—­</button>
    </div>
  </div>

  <script>
    (function () {
      const logContainer = document.getElementById('log');
      const statusEl = document.getElementById('status');
      const spinnerEl = document.getElementById('spinner');
      const countdownEl = document.getElementById('countdown');
      
      let allLogs = [];
      let autoCloseTimer = null;
      
      // ğŸ”¥ è°ƒè¯•æ¨¡å¼: true = ä¸è‡ªåŠ¨å…³é—­, false = 5ç§’åè‡ªåŠ¨å…³é—­
      const DEBUG_MODE = true;

      // æ—¥å¿—å‡½æ•°
      function log(message, type = 'info') {
        const time = new Date().toLocaleTimeString('zh-CN', { hour12: false, fractionalSecondDigits: 3 });
        const logText = `[${time}] [${type.toUpperCase()}] ${message}`;
        allLogs.push(logText);
        
        const logItem = document.createElement('div');
        logItem.className = `log-item log-${type}`;
        logItem.textContent = logText;
        logContainer.appendChild(logItem);
        logContainer.scrollTop = logContainer.scrollHeight;
        
        console.log(logText);
      }

      function updateStatus(text, hideSpinner = false) {
        statusEl.textContent = text;
        if (hideSpinner) {
          spinnerEl.style.display = 'none';
        }
      }

      function copyLogs() {
        const logsText = allLogs.join('\n');
        navigator.clipboard.writeText(logsText).then(() => {
          alert('âœ… æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿!');
        }).catch(err => {
          alert('âŒ å¤åˆ¶å¤±è´¥: ' + err);
        });
      }

      function startCountdown(seconds) {
        let remaining = seconds;
        countdownEl.textContent = `${remaining} ç§’åè‡ªåŠ¨å…³é—­...`;
        
        const interval = setInterval(() => {
          remaining--;
          if (remaining <= 0) {
            clearInterval(interval);
            window.close();
          } else {
            countdownEl.textContent = `${remaining} ç§’åè‡ªåŠ¨å…³é—­...`;
          }
        }, 1000);
      }

      // æš´éœ²åˆ°å…¨å±€ä¾›æŒ‰é’®è°ƒç”¨
      window.copyLogs = copyLogs;

      try {
        log('========================================', 'info');
        log('ğŸš€ Telegram æˆæƒå¤„ç†è„šæœ¬å¯åŠ¨', 'info');
        log('========================================', 'info');
        log(`ğŸ• å¯åŠ¨æ—¶é—´: ${new Date().toISOString()}`, 'info');
        log(`ğŸ“ å®Œæ•´ URL: ${window.location.href}`, 'info');
        log(`ğŸ”— Hash éƒ¨åˆ†: ${window.location.hash || '(ç©º)'}`, 'info');
        log(`â“ Search éƒ¨åˆ†: ${window.location.search || '(ç©º)'}`, 'info');
        log(`ğŸªŸ window.opener å­˜åœ¨: ${!!window.opener}`, 'info');
        log(`ğŸŒ å½“å‰åŸŸå: ${window.location.origin}`, 'info');
        log(`ğŸ› è°ƒè¯•æ¨¡å¼: ${DEBUG_MODE ? 'å¼€å¯ (ä¸è‡ªåŠ¨å…³é—­)' : 'å…³é—­ (5ç§’åå…³é—­)'}`, 'info');
        log('========================================', 'info');

        let authData = {};

        // 1ï¸âƒ£ å°è¯•ä» hash ä¸­è§£æ
        if (window.location.hash.startsWith('#tgAuthResult=')) {
          log('âœ¨ æ£€æµ‹åˆ° hash ä¸­çš„æˆæƒæ•°æ®', 'success');
          
          const encoded = window.location.hash.replace('#tgAuthResult=', '');
          log(`ğŸ“¦ Base64URL ç¼–ç æ•°æ® (å‰50å­—ç¬¦): ${encoded.substring(0, 50)}...`, 'info');
          log(`ğŸ“ ç¼–ç æ•°æ®æ€»é•¿åº¦: ${encoded.length}`, 'info');
          
          try {
            const base64 = encoded.replace(/-/g, '+').replace(/_/g, '/');
            log('ğŸ”„ å·²è½¬æ¢ä¸ºæ ‡å‡† Base64 æ ¼å¼', 'info');
            
            const decoded = atob(base64);
            log(`ğŸ“ Base64 è§£ç åå­—èŠ‚é•¿åº¦: ${decoded.length}`, 'info');
            
            const json = decodeURIComponent(
              decoded
                .split('')
                .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
                .join('')
            );
            log(`ğŸ“„ è½¬æ¢ä¸º UTF-8 å­—ç¬¦ä¸²æˆåŠŸ`, 'info');
            log(`ğŸ“ƒ JSON å­—ç¬¦ä¸²: ${json}`, 'info');
            
            authData = JSON.parse(json);
            log('âœ… JSON è§£ææˆåŠŸ!', 'success');
            log(`ğŸ‘¤ è§£æåçš„æ•°æ®:`, 'success');
            log(JSON.stringify(authData, null, 2), 'success');
            log(`ğŸ”‘ åŒ…å«çš„å­—æ®µ: ${Object.keys(authData).join(', ')}`, 'success');
            
          } catch (e) {
            log(`âŒ è§£æ hash æ•°æ®æ—¶å‡ºé”™: ${e.message}`, 'error');
            log(`âŒ é”™è¯¯å †æ ˆ: ${e.stack}`, 'error');
          }
        } else {
          log('âš ï¸ URL hash ä¸æ˜¯ä»¥ #tgAuthResult= å¼€å¤´', 'error');
        }

        // 2ï¸âƒ£ å…œåº•: query å‚æ•°
        if (!Object.keys(authData).length && window.location.search) {
          log('ğŸ” å°è¯•ä» query å‚æ•°è·å–æ•°æ®...', 'info');
          
          const params = new URLSearchParams(window.location.search);
          let paramCount = 0;
          for (const [key, value] of params.entries()) {
            authData[key] = value;
            paramCount++;
            log(`  ğŸ“Œ ${key}: ${value}`, 'info');
          }
          
          if (paramCount > 0) {
            log(`âœ… ä» query è·å–åˆ° ${paramCount} ä¸ªå‚æ•°`, 'success');
          }
        }

        log('========================================', 'info');
        
        // 3ï¸âƒ£ å‘é€æ•°æ®
        const dataKeys = Object.keys(authData);
        if (dataKeys.length === 0) {
          log('âŒ æœªæ‰¾åˆ°ä»»ä½•æˆæƒæ•°æ®!', 'error');
          updateStatus('âŒ æˆæƒæ•°æ®ä¸ºç©º', true);
          
        } else if (!window.opener) {
          log('âŒ window.opener ä¸å­˜åœ¨,æ— æ³•å‘é€æ•°æ®', 'error');
          log('â„¹ï¸ è¿™å¯èƒ½æ˜¯å› ä¸º: 1) çª—å£ä¸æ˜¯é€šè¿‡ window.open æ‰“å¼€çš„, 2) çˆ¶çª—å£å·²å…³é—­, 3) è·¨åŸŸé™åˆ¶', 'info');
          updateStatus('âŒ æ— æ³•é€šä¿¡: çˆ¶çª—å£ä¸å¯ç”¨', true);
          
        } else {
          log('ğŸ“¤ å‡†å¤‡å‘é€æ•°æ®ç»™çˆ¶çª—å£...', 'info');
          log(`ğŸ“Š æ•°æ®åŒ…å« ${dataKeys.length} ä¸ªå­—æ®µ: ${dataKeys.join(', ')}`, 'info');
          log(`ğŸ¯ å‘é€çš„å®Œæ•´æ•°æ®:`, 'info');
          log(JSON.stringify(authData, null, 2), 'info');
          
          // å‘é€æ¶ˆæ¯
          window.opener.postMessage(authData, '*');
          
          log('âœ… postMessage() å·²è°ƒç”¨å®Œæˆ', 'success');
          log('ğŸ¯ ç›®æ ‡æº: * (ä»»æ„æº)', 'info');
          log('â„¹ï¸ å¦‚æœ Flutter æ²¡æ”¶åˆ°,è¯·æ£€æŸ¥:', 'info');
          log('  1. Flutter ç›‘å¬å™¨æ˜¯å¦æ­£ç¡®è®¾ç½®', 'info');
          log('  2. ç›‘å¬å™¨æ˜¯å¦åœ¨ postMessage ä¹‹å‰å°±å·²è®¾ç½®', 'info');
          log('  3. æ˜¯å¦æœ‰è·¨åŸŸæˆ– CSP ç­–ç•¥é˜»æ­¢', 'info');
          
          updateStatus('âœ… æ•°æ®å·²å‘é€ç»™çˆ¶çª—å£!', true);
          
          if (!DEBUG_MODE) {
            log('â³ 5 ç§’åè‡ªåŠ¨å…³é—­çª—å£...', 'info');
            startCountdown(5);
          } else {
            log('ğŸ› è°ƒè¯•æ¨¡å¼: çª—å£ä¸ä¼šè‡ªåŠ¨å…³é—­', 'info');
            countdownEl.textContent = 'ğŸ› è°ƒè¯•æ¨¡å¼: ä¸ä¼šè‡ªåŠ¨å…³é—­';
          }
        }
        
        log('========================================', 'info');

      } catch (e) {
        log(`ğŸ’¥ è‡´å‘½é”™è¯¯: ${e.message}`, 'error');
        log(`ğŸ’¥ é”™è¯¯å †æ ˆ: ${e.stack}`, 'error');
        updateStatus('âŒ å‘ç”Ÿé”™è¯¯', true);
      }
    })();
  </script>
</body>
</html>
